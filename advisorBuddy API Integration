//Backend
// Import necessary Wix modules
import { getSecret } from 'wix-secrets-backend';
import {fetch} from 'wix-fetch';

// Fetch API Key securely from Wix Secrets Manager
async function getApiKey() {
    return await getSecret("api_key");
}

// **Create Request Endpoint**
export async function createRequest(data) {
    const apiKey = await getApiKey();
    const url = 'https://crm.advisorbuddy.ca/api/v1/requests/create';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();
            console.log(result);
            return result;
        } else {
            const error = await response.json();
            throw new Error(`Error creating request: ${JSON.stringify(error)}`);
        }
    } catch (err) {
        console.error('Error in createRequest:', err.message);
        throw err;
    }
}

// **Read Audit Endpoint**
export async function readAudit(auditNumber) {
    const apiKey = await getApiKey();
    const url = 'https://crm.advisorbuddy.ca/api/v1/audits/get';

    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                audit_number: auditNumber
            })
        });

        if (response.ok) {
            const result = await response.json();
            return result;
        } else {
            const error = await response.json();
            throw new Error(`Error reading audit: ${JSON.stringify(error)}`);
        }
    } catch (err) {
        console.error('Error in readAudit:', err.message);
        throw err;
    }
}
//Frontend
import { createRequest } from 'backend/advisorBuddy';

$w('#submit').onClick(async() => {
    let fname = $w('#fname').value;
    let lname = $w('#lname').value;
    let email = $w('#email').value;
    let phone = $w('#phone').value;
    let address = $w('#address').value;
    let city = $w('#city').value;
    let zipCode = $w('#zipCode').value;
    let province = $w('#province').value;
    let inquiry = $w('#inquiryPurpose').value;
    let aboutUs = $w('#aboutUs').value;
    let comment = $w('#comments').value;

    // Ensure phone number only takes 10 digits
    phone = phone.replace(/\D/g, '').slice(0, 10);

    const requestData = {
        firstname: fname,
        lastname: lname,
        mobile: phone,
        email: email,
        address_street: address,
        address_city: city,
        address_province: province,
        address_postalcode: zipCode,
        inquiry_Purpose: inquiry,
        know_about_us: aboutUs,
        client_message: comment,
    };
    console.log(requestData);

    await createRequest(requestData)
        .then(response => {
            console.log('Request Created:', response);
        })
        .catch(err => {
            console.error('Error:', err);
        });
});

